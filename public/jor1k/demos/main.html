<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>jor1k: OpenRISC OR1K Javascript Emulator (Full-Screen Terminal)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* MINIMAL BLACK THEME - FULL SCREEN */
        body {
            font-family: 'Consolas', monospace;
            background: #000000;
            color: #FFFFFF;
            padding: 0;
            margin: 0;
            /* Ensure body covers the viewport for the container to fill it */
            width: 100vw; 
            height: 100vh;
        }

        /* --- TERMINAL CONTAINER STYLING (FULL VIEWPORT) --- */
        .minimal-panel {
            background-color: #050505; 
            border: none;
            border-radius: 0;
            box-shadow: none;
            /* Fill the entire screen */
            width: 100vw;
            height: 100vh; 
            display: flex;
            flex-direction: column;
            padding: 0;
            margin: 0;
        }

        /* --- TERMINAL DISPLAY STYLING --- */
        .terminal-display {
            font-family: inherit;
            background-color: inherit;
            color: #FFFFFF;
            text-shadow: 0 0 5px #AAAAAA; 
            border: none;
            box-shadow: none;
            overflow: auto;
            /* Fills all vertical space between controls and top */
            flex-grow: 1; 
            padding: 1rem; 
        }

        /* TTY Table Overrides for Full Height */
        #tty, #tty td, #tty tr {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            border: none;
            box-shadow: none;
        }

        /* Hide canvases when not in use */
        #fb, #fbfullscreen {
            display: none;
        }
        
        /* --- CONTROL STYLING --- */
        .controls-bar {
            background-color: #1a1a1a;
            border-top: 1px solid #333333;
            padding: 0.5rem 1rem;
            flex-shrink: 0; /* Keep controls bar fixed size */
        }

        .controls-bar input[type="text"], .controls-bar select {
            background-color: #333333;
            border: 1px solid #555555;
            color: #FFFFFF;
            border-radius: 0.25rem;
            padding: 0.2rem 0.4rem;
            font-size: 0.875rem;
        }
        
        .controls-bar button, .controls-bar label i {
            color: #AAAAAA;
        }
        .controls-bar button:hover, .controls-bar label:hover i {
            color: #FFFFFF;
        }
        
    </style>
</head>
<body onload="Start()">

    <canvas id="fbfullscreen" style="display: none;"></canvas>
    <canvas id="fb" style="display: none;"></canvas>

    <main class="minimal-panel">
        
        <div class="terminal-display"> 
            <table id="tty" cellpadding="0" cellspacing="0"></table>
        </div>

        <div class="controls-bar flex flex-wrap items-center gap-2">

            <select id="fpsselect" onchange='jor1k.framebuffer.SetFPS(this.options[this.selectedIndex].value)' class="w-auto">
                <option value="0">0 FPS</option>
                <option value="5">5 FPS</option>
                <option value="10">10 FPS</option>
                <option value="20">20 FPS</option>
                <option value="30" selected>30 FPS</option> 
            </select>

            <input type="text" id="loadPath" class="h-7 flex-grow min-w-[100px]" value="/home/user" />
            
            <label class="cursor-pointer" title="Upload to folder">
                <i class="fas fa-upload text-lg"></i>
                <input type="file" id="files" class="hidden" name="files[]" onchange='OnUploadFiles(this.files)' multiple />
            </label>
            <button onclick='jor1k.fs.TAR(document.getElementById("loadPath").value)' title="Download of folder">
                <i class="fas fa-file-download text-lg"></i>
            </button>
            <button onclick='jor1k.fs.Sync("home/user")' title="Sync with server">
                <i class="fas fa-sync-alt text-lg"></i>
            </button>

            <button onclick='Fullscreen()' title="Windowed fullscreen of framebuffer (if active)" class="ml-auto">
                <i class="fas fa-expand text-lg"></i>
            </button>

            <div class="flex items-center space-x-1">
                <input type="checkbox" id="audio-toggle" onclick='jor1k.sound.Enabled(this.checked)' class="rounded bg-gray-700 border-gray-600 focus:ring-white text-white w-3 h-3">
                <label for="audio-toggle" class="text-xs text-gray-400">Audio</label>
            </div>

            <span id="stats" class="text-xs text-gray-500"></span>
            
            <textarea class="hidden" id="clipboard">clipb</textarea>
        </div>

    </main>

    <div id="console" class="hidden"></div>


    <script src="jor1k-master-min.js"></script>

    <script>
    // Assuming Jor1k and LinuxTerm are exposed globally by jor1k-master-min.js
    var Jor1k = window.Jor1k || require("Jor1k");
    var LinuxTerm = window.LinuxTerm || require("LinuxTerm");
    var jor1k = null; 

    function Fullscreen() {
        document.body.style.margin = '0px';
        document.querySelector('main').style.display = 'none';

        var fb = document.getElementById("fbfullscreen");
        fb.style.visibility = 'visible'; 
        fb.style.display = 'block'; 
        
        window.onresize = function(event) {
            var w = window,
            d = document,
            e = d.documentElement,
            g = d.getElementsByTagName('body')[0],
            x = w.innerWidth || e.clientWidth || g.clientWidth,
            y = w.innerHeight|| e.clientHeight|| g.clientHeight;

            var d_ratio = x/y;
            if (d_ratio > 1.6) x = y*1.6; else y = x/1.6;

            fb.style.width = "" + x + "px";
            fb.style.height = "" + y + "px";
        };
        window.onresize();
        jor1k.framebuffer.Init("fbfullscreen");
    }

    function OnUploadFiles(files) {
        var path = document.getElementById("loadPath").value;
        for (var i = 0, f; f = files[i]; i++) {
            jor1k.fs.UploadExternalFile(path, f);
        }
    }

    function RandomString(length) {
        var chars = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
        var result = '';
        for (var i = length; i > 0; --i) result += chars[Math.round(Math.random() * (chars.length - 1))];
        return result;
    }

    function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i=0;i<vars.length;i++) {
                    var pair = vars[i].split("=");
                    if(pair[0] == variable){return decodeURIComponent(pair[1]);}
            }
            return(false);
    }

    function Start() {
        var pushState = false, loadUserData = false;
        var userid = getQueryVariable("user");
        
        if (userid == false) {
            userid = RandomString(10);
            pushState = true;
        } else {
            loadUserData = true;
        }
        
        var relayURL = getQueryVariable("relayURL")
        if (relayURL == false) {
            relayURL = "wss://relay.widgetry.org/";
            pushState = true;
        }

        // Configuration parameters for Jor1k
        jor1kparameters = {
            path: "../openrisc-sys/",
            system: {
                kernelURL: "kernel/vmlinux.bin.bz2", 
                memorysize: 32, 
                cpu: "asm", 
                ncores: 1,
            },
            fs: {
                basefsURL: "basefs.json", 
                extendedfsURL: "fs.json", 
                earlyload: [], 
                lazyloadimages: [] 
            },

            term: new LinuxTerm("tty"),      
            fbid: "fb",                      
            clipboardid: "clipboard",        
            statsid: "stats",                
            fps: 30,                         
            relayURL: relayURL,              
            userid: userid,                  
            syncURL: "//jor1k.com/sync/upload.php" 
        }

        if (loadUserData)
            jor1kparameters.fs.lazyloadimages.push("sync/tarballs/"+userid+".tar.bz2");

        var nCores = getQueryVariable("n");
        if (nCores != false) {
            jor1kparameters.system.ncores = nCores;
        } else {
            pushState = true;
        }
        
        var cpu = getQueryVariable("cpu");
        if (cpu != false) {
            jor1kparameters.system.cpu = cpu;
            if (jor1kparameters.system.cpu == "smp") {
                 jor1kparameters.system.kernelURL = "kernel/vmlinuxsmp.bin.bz2";
            }
        } else {
            pushState = true;
        }
        
        if (pushState) {
            window.history.pushState([], "", "?user="+encodeURIComponent(jor1kparameters.userid)+"&cpu="+encodeURIComponent(jor1kparameters.system.cpu)+"&n="+encodeURIComponent(jor1kparameters.system.ncores)+"&relayURL="+encodeURIComponent(relayURL));
        }

        // Initialize the emulator
        jor1k = new Jor1k(jor1kparameters);
        
        // Match the FPS dropdown to the initial setting
        document.getElementById('fpsselect').value = jor1kparameters.fps;
    }
    </script>

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-44129312-1', 'auto');
      ga('send', 'pageview');
    </script>
</body>
</html>