<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>lp.profiles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { background:#0d0d0d; color:#fff; font-family:"JetBrains Mono",monospace; margin:0; height:100vh; display:flex; align-items:center; justify-content:center; }
    .wrap { width:960px; background:#121212; padding:18px; border-radius:12px; display:flex; gap:16px; box-shadow:0 10px 40px rgba(0,0,0,0.7); }

    #sidebar { width:260px; background:#0f0f0f; border-radius:8px; padding:12px; height:600px; display:flex; flex-direction:column; }
    .tabs { display:flex; }
    .tab { flex:1; text-align:center; padding:6px; cursor:pointer; background:#1a1a1a; border-radius:6px 6px 0 0; }
    .tab.active { background:#222; font-weight:bold; }
    .list { flex:1; overflow:auto; background:#111; padding:8px; border-radius:0 0 6px 6px; }
    .item { padding:8px; border-radius:6px; cursor:pointer; margin-bottom:6px; background:transparent; }
    .item:hover, .item.active { background:#1a1a1a; }
    .group-tag { font-weight:700; color:#9ad; }

    #main { flex:1; display:flex; flex-direction:column; gap:12px; }
    .top { display:flex; justify-content:space-between; align-items:center; }
    #chatBox { background:#0b0b0b; flex:1; border-radius:8px; padding:12px; overflow:auto; display:flex; flex-direction:column; gap:4px; }

    .msg-line { display:flex; margin-bottom:8px; }
    .msg-line.me { justify-content:flex-end; }
    .bubble { padding:8px 10px; border-radius:12px; max-width:70%; word-wrap:break-word; line-height:1.4; }
    .me .bubble { background:#162b3a; text-align:right; }
    .them .bubble { background:#222; text-align:left; }
    .meta { font-size:10px; opacity:0.6; margin-top:2px; }

    input, button { background:#0b0b0b; color:#fff; border:1px solid #222; padding:8px; border-radius:8px; }
    button.small { font-size:13px; padding:6px; }
    #controls { display:flex; gap:8px; }

    #status { position: absolute; top: 10px; right: 10px; font-size: 12px; color: #0f0; background: #000; padding: 4px 8px; border-radius: 4px; }
  </style>
</head>
<body>
  <div id="status">Connecting...</div>

  <div class="wrap">
    <div id="sidebar">
      <div class="tabs">
        <div id="tabFriends" class="tab active">Friends</div>
        <div id="tabGroups" class="tab">Groups</div>
      </div>
      <div id="friendsList" class="list"></div>
      <div id="groupsList" class="list" style="display:none;"></div>
    </div>

    <div id="main">
      <div class="top">
        <div><h3>Your ID: <span id="myId">loading...</span></h3></div>
        <div><button id="changeBtn" class="small">Change Username</button></div>
      </div>

      <div id="chatBox">
        <div style="color:#666; text-align:center; margin-top:20px;">Select a friend or group to start chatting</div>
      </div>

      <div id="controls">
        <input id="targetInput" placeholder="target username or group id" style="flex:1;" />
        <input id="textInput" placeholder="message" style="flex:3;" />
        <button id="sendBtn">Send</button>
      </div>

      <div id="createGroupArea" style="margin-top:10px;border-top:1px solid #1a1a1a;padding-top:10px;">
        <input id="groupLabel" placeholder="group label" class="small" />
        <input id="groupMembers" placeholder="members (comma separated)" class="small" />
        <button id="createBtn" class="small">Create Group</button>
      </div>
    </div>
  </div>

  <!-- Socket.IO client from CDN (reliable) -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const statusEl = document.getElementById("status");
    const stored = localStorage.getItem("void_username");

    // Connect to Socket.IO with correct path
    const socket = io({
      path: "/profiles/socket.io/",
      auth: { username: stored || null },
      transports: ["websocket"], // Force WebSocket only (fixes polling issues)
    });

    let myId = null;
    let friends = [];
    let groups = {};
    let currentKey = null;

    const friendsList = document.getElementById("friendsList");
    const groupsList = document.getElementById("groupsList");
    const myIdEl = document.getElementById("myId");
    const chatBox = document.getElementById("chatBox");
    const textInput = document.getElementById("textInput");
    const targetInput = document.getElementById("targetInput");

    // Update status
    function setStatus(msg, color = "#0f0") {
      statusEl.textContent = msg;
      statusEl.style.color = color;
    }

    // Render list
    function renderList(list, container, isGroup = false) {
      container.innerHTML = "";
      if (list.length === 0) {
        const empty = document.createElement("div");
        empty.style.color = "#666";
        empty.style.fontStyle = "italic";
        empty.textContent = isGroup ? "No groups yet" : "No friends yet";
        container.appendChild(empty);
        return;
      }
      list.forEach(item => {
        const div = document.createElement("div");
        div.className = "item";
        div.textContent = isGroup ? `#${item.label}` : item;
        div.onclick = () => {
          document.querySelectorAll(".item").forEach(i => i.classList.remove("active"));
          div.classList.add("active");
          chatBox.innerHTML = "<div style='color:#666; text-align:center; margin-top:20px;'>Loading messages...</div>";
          if (isGroup) {
            currentKey = "group:" + item.id;
            targetInput.value = `group:${item.id}`;
            socket.emit("getGroup", { groupId: item.id });
          } else {
            currentKey = "dm:" + [myId, item].sort().join("|");
            targetInput.value = item;
            socket.emit("getDM", { target: item });
          }
        };
        container.appendChild(div);
      });
    }

    // Render message
    function renderMessage(entry) {
      const div = document.createElement("div");
      div.className = "msg-line " + (entry.from === myId ? "me" : "them");
      const time = new Date(entry.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      div.innerHTML = `
        <div class="bubble">
          ${entry.text}
          <div class="meta">${entry.from} â€¢ ${time}</div>
        </div>
      `;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function addSystem(msg) {
      const div = document.createElement("div");
      div.className = "msg-line them";
      div.innerHTML = `<div class="bubble" style="opacity:0.7; background:#333;">System: ${msg}</div>`;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Socket Events
    socket.on("connect", () => {
      setStatus("Connected", "#0f0");
      console.log("Socket connected:", socket.id);
    });

    socket.on("connect_error", (err) => {
      setStatus("Connection failed", "#f00");
      console.error("Connect error:", err);
      addSystem("Connection failed: " + err.message);
    });

    socket.on("disconnect", () => {
      setStatus("Disconnected", "#f80");
      console.log("Socket disconnected");
    });

    socket.on("init", data => {
      console.log("INIT received:", data);
      myId = data.username;
      myIdEl.textContent = myId || "Unknown"; // Ensure it updates even if empty
      localStorage.setItem("void_username", myId);

      friends = data.friends || [];
      renderList(friends, friendsList); // Explicit render

      groups = {};
      (data.groups || []).forEach(g => groups[g.id] = g);
      renderList(Object.values(groups), groupsList, true); // Explicit render

      setStatus(`Online as ${myId}`, "#0f0");
      chatBox.innerHTML = "<div style='color:#666; text-align:center; margin-top:20px;'>Select a friend or group to chat</div>";
    });

    socket.on("dm", ({ key, entry }) => {
      const parts = key.split("|");
      const other = parts[0] === myId ? parts[1] : parts[0];
      if (!friends.includes(other)) {
        friends.push(other);
        renderList(friends, friendsList);
      }
      if (currentKey === "dm:" + key) {
        renderMessage(entry);
      }
    });

    socket.on("dmHistory", ({ history }) => {
      chatBox.innerHTML = "";
      if (history.length === 0) {
        chatBox.innerHTML = "<div style='color:#666; text-align:center; margin-top:20px;'>No messages yet</div>";
      } else {
        history.forEach(renderMessage);
      }
    });

    socket.on("groupCreated", g => {
      groups[g.id] = g;
      renderList(Object.values(groups), groupsList, true);
      addSystem(`Group "${g.label}" created`);
    });

    socket.on("groupMsg", ({ groupId, entry }) => {
      if (currentKey === "group:" + groupId) {
        renderMessage(entry);
      }
    });

    socket.on("groupHistory", ({ history }) => {
      chatBox.innerHTML = "";
      if (history.length === 0) {
        chatBox.innerHTML = "<div style='color:#666; text-align:center; margin-top:20px;'>No messages yet</div>";
      } else {
        history.forEach(renderMessage);
      }
    });

    socket.on("addFriend", ({ friend }) => {
      if (!friends.includes(friend)) {
        friends.push(friend);
        renderList(friends, friendsList);
      }
    });

    socket.on("system", ({ msg }) => addSystem(msg));

    // Send message
    document.getElementById("sendBtn").onclick = () => {
      const target = targetInput.value.trim();
      const text = textInput.value.trim();
      if (!target || !text) return;
      if (target.startsWith("group:")) {
        const id = target.split(":")[1];
        socket.emit("sendGroup", { groupId: id, text });
      } else {
        socket.emit("sendDM", { target, text });
      }
      textInput.value = "";
    };

    // Create group
    document.getElementById("createBtn").onclick = () => {
      const label = document.getElementById("groupLabel").value.trim();
      const members = document.getElementById("groupMembers").value.split(",").map(x => x.trim()).filter(Boolean);
      if (!label) return addSystem("Group label required");
      if (!members.includes(myId)) members.push(myId);
      socket.emit("createGroup", { label, members });
      document.getElementById("groupLabel").value = "";
      document.getElementById("groupMembers").value = "";
    };

    // Change username
    document.getElementById("changeBtn").onclick = () => {
      const newName = prompt("Enter new username:", myId);
      if (newName && newName !== myId) {
        localStorage.setItem("void_username", newName);
        location.reload();
      }
    };

    // Tab switching
    document.getElementById("tabFriends").onclick = () => {
      document.getElementById("tabFriends").classList.add("active");
      document.getElementById("tabGroups").classList.remove("active");
      friendsList.style.display = "block";
      groupsList.style.display = "none";
    };
    document.getElementById("tabGroups").onclick = () => {
      document.getElementById("tabGroups").classList.add("active");
      document.getElementById("tabFriends").classList.remove("active");
      friendsList.style.display = "none";
      groupsList.style.display = "block";
    };

    // Allow Enter to send
    textInput.addEventListener("keypress", e => {
      if (e.key === "Enter") document.getElementById("sendBtn").click();
    });
  </script>
</body>
</html>